services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil", "--host", "0.0.0.0", "--port", "8545", "--chain-id", "31337", "--accounts", "10", "--balance", "10000"]
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "cast", "chain-id", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      PORT: "3001"
      ANVIL_RPC_URL: "http://anvil:8545"
      CHAIN_ID: "31337"
      API_KEY: "sigloop-dev-key"
    depends_on:
      anvil:
        condition: service_healthy
    volumes:
      - ./backend/src:/app/src
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  webapp:
    build:
      context: ./webapp
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: "http://localhost:3001"
      VITE_ANVIL_RPC_URL: "http://localhost:8545"
      VITE_CHAIN_ID: "31337"
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./webapp/src:/app/src

  rest:
    build:
      context: ./rest
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    environment:
      PORT: "3002"
      BACKEND_URL: "http://backend:3001"
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./rest/src:/app/src
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3002/api/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  contract-deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    working_dir: /contracts
    entrypoint: ["forge", "script", "script/Deploy.s.sol", "--rpc-url", "http://anvil:8545", "--private-key", "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80", "--broadcast"]
    volumes:
      - ../testing/ai/contracts:/contracts
    depends_on:
      anvil:
        condition: service_healthy

networks:
  default:
    name: sigloop-dev

# x402

[<- Back to README](./README.md) | [Previous: Policy](./policy.md) | [Next: Chain ->](./chain.md)

---

The x402 module implements the [HTTP 402 Payment Required](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/402) protocol for agent-to-service payments. When an HTTP response returns status 402 with an `X-Payment-Requirements` header, the middleware automatically signs an EIP-3009 `TransferWithAuthorization` and retries the request with an `X-PAYMENT` header.

```typescript
import {
  createX402Middleware,
  signEIP3009Authorization,
  buildPaymentHeader,
  parsePaymentHeader,
  BudgetTracker,
  createX402Client,
} from "@sigloop/sdk";
```

---

## Middleware

### `X402MiddlewareOptions`

```typescript
interface X402MiddlewareOptions {
  account: LocalAccount;
  walletAddress: Address;
  chainId: number;
  config: X402Config;
  onPayment?: (record: PaymentRecord) => void;
  onPaymentRejected?: (requirement: PaymentRequirement, reason: string) => void;
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `account` | `LocalAccount` | Yes | The account used to sign EIP-3009 authorizations |
| `walletAddress` | `Address` | Yes | The `from` address for payment authorizations |
| `chainId` | `number` | Yes | The chain ID for EIP-712 domain |
| `config` | [`X402Config`](./types.md#x402config) | Yes | Payment budget and approval configuration |
| `onPayment` | `(record: PaymentRecord) => void` | No | Callback invoked after a successful payment |
| `onPaymentRejected` | `(requirement: PaymentRequirement, reason: string) => void` | No | Callback invoked when a payment is rejected by budget policy |

---

### `createX402Middleware`

Creates a `fetch`-compatible function that intercepts 402 responses and automatically handles payment. The returned function has the same signature as the global `fetch`.

```typescript
function createX402Middleware(options: X402MiddlewareOptions): typeof fetch
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `options` | `X402MiddlewareOptions` | Middleware configuration |

**Returns:** `typeof fetch` -- A fetch-compatible function with x402 payment handling.

**Behavior:**
1. Makes the initial HTTP request.
2. If the response status is not 402, returns the response as-is.
3. If 402, reads the `X-Payment-Requirements` header.
4. Validates the payment against the budget policy (amount, domain, asset).
5. If `autoApprove` is `false` or the budget check fails, returns the original 402 response.
6. Signs an EIP-3009 `TransferWithAuthorization`.
7. Retries the request with the `X-PAYMENT` header containing the signed authorization.
8. Records the payment in the internal budget tracker.

**Example:**

```typescript
import { createX402Middleware } from "@sigloop/sdk";
import { privateKeyToAccount } from "viem/accounts";

const account = privateKeyToAccount("0x...");

const x402Fetch = createX402Middleware({
  account,
  walletAddress: "0xMyWallet...",
  chainId: 8453,
  config: {
    maxPaymentPerRequest: 1000000n,
    maxTotalPayment: 50000000n,
    autoApprove: true,
    allowedDomains: ["api.example.com"],
    allowedAssets: ["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"],
  },
  onPayment: (record) => {
    console.log(`Paid ${record.amount} to ${record.payTo}`);
  },
  onPaymentRejected: (req, reason) => {
    console.warn(`Payment rejected: ${reason}`);
  },
});

const response = await x402Fetch("https://api.example.com/data");
const data = await response.json();
```

---

## Payment Signing

### `signEIP3009Authorization`

Signs an EIP-3009 `TransferWithAuthorization` using EIP-712 typed data signing. This is the core mechanism for authorizing USDC transfers without an on-chain approval transaction.

```typescript
function signEIP3009Authorization(
  account: LocalAccount,
  params: {
    tokenAddress: Address;
    from: Address;
    to: Address;
    value: bigint;
    validAfter: bigint;
    validBefore: bigint;
    chainId: number;
  }
): Promise<{ authorization: EIP3009Authorization; signature: Hex }>
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `account` | `LocalAccount` | The account signing the authorization |
| `params.tokenAddress` | `Address` | The ERC-20 token contract (e.g., USDC) |
| `params.from` | `Address` | The sender address |
| `params.to` | `Address` | The recipient address |
| `params.value` | `bigint` | The transfer amount |
| `params.validAfter` | `bigint` | Unix timestamp after which the authorization is valid |
| `params.validBefore` | `bigint` | Unix timestamp before which the authorization is valid |
| `params.chainId` | `number` | The chain ID for EIP-712 domain |

**Returns:** An object containing:
- `authorization` ([`EIP3009Authorization`](./types.md#eip3009authorization)) -- The authorization data
- `signature` (`Hex`) -- The EIP-712 signature

**Example:**

```typescript
import { signEIP3009Authorization } from "@sigloop/sdk";
import { privateKeyToAccount } from "viem/accounts";

const account = privateKeyToAccount("0x...");

const now = BigInt(Math.floor(Date.now() / 1000));
const { authorization, signature } = await signEIP3009Authorization(account, {
  tokenAddress: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
  from: "0xMyWallet...",
  to: "0xServiceProvider...",
  value: 1000000n,
  validAfter: now,
  validBefore: now + 300n,
  chainId: 8453,
});
```

---

### `buildPaymentHeader`

Builds a base64-encoded `X-PAYMENT` header value from an authorization, signature, and payment requirement.

```typescript
function buildPaymentHeader(
  authorization: EIP3009Authorization,
  signature: Hex,
  requirement: PaymentRequirement
): string
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `authorization` | [`EIP3009Authorization`](./types.md#eip3009authorization) | The signed authorization |
| `signature` | `Hex` | The EIP-712 signature |
| `requirement` | [`PaymentRequirement`](./types.md#paymentrequirement) | The original payment requirement from the 402 response |

**Returns:** `string` -- Base64-encoded JSON payload for the `X-PAYMENT` header.

The payload structure:
```json
{
  "x402Version": 1,
  "scheme": "...",
  "network": "...",
  "payload": {
    "signature": "0x...",
    "authorization": {
      "from": "0x...",
      "to": "0x...",
      "value": "...",
      "validAfter": "...",
      "validBefore": "...",
      "nonce": "0x..."
    }
  }
}
```

---

### `parsePaymentHeader`

Parses a base64-encoded `X-PAYMENT` header back into its components.

```typescript
function parsePaymentHeader(header: string): {
  authorization: EIP3009Authorization;
  signature: Hex;
  scheme: string;
  network: string;
}
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `header` | `string` | The base64-encoded X-PAYMENT header value |

**Returns:** An object with the decoded `authorization`, `signature`, `scheme`, and `network`.

**Example:**

```typescript
import { parsePaymentHeader } from "@sigloop/sdk";

const header = response.headers.get("X-PAYMENT");
if (header) {
  const { authorization, signature, scheme, network } = parsePaymentHeader(header);
  console.log("Payment from:", authorization.from);
  console.log("Amount:", authorization.value);
}
```

---

## Budget Tracking

### `BudgetTracker` (class)

Tracks payment history and enforces budget limits. Used internally by the middleware and client, but also available for standalone use.

```typescript
class BudgetTracker {
  constructor(policy: X402Policy)
  canSpend(amount: bigint, asset: Address, domain?: string): boolean
  recordPayment(record: PaymentRecord): void
  getDailySpend(asset?: Address): bigint
  getTotalSpend(asset?: Address): bigint
  getRemainingDailyBudget(asset?: Address): bigint
  getRemainingPerRequestBudget(): bigint
  getPaymentHistory(): PaymentRecord[]
  getPaymentCount(): number
  clearHistory(): void
  pruneExpiredRecords(maxAgeSeconds?: number): void
}
```

**Constructor:**

| Name | Type | Description |
|------|------|-------------|
| `policy` | [`X402Policy`](./types.md#x402policy) | Budget policy configuration |

**Methods:**

| Method | Returns | Description |
|--------|---------|-------------|
| `canSpend(amount, asset, domain?)` | `boolean` | Checks if a payment is allowed by the budget policy. Validates amount, domain allowlist, asset allowlist, and daily spend limits |
| `recordPayment(record)` | `void` | Records a completed payment |
| `getDailySpend(asset?)` | `bigint` | Returns total spend in the last 24 hours, optionally filtered by asset |
| `getTotalSpend(asset?)` | `bigint` | Returns total all-time spend, optionally filtered by asset |
| `getRemainingDailyBudget(asset?)` | `bigint` | Returns remaining daily budget (clamped to 0) |
| `getRemainingPerRequestBudget()` | `bigint` | Returns the per-request maximum |
| `getPaymentHistory()` | `PaymentRecord[]` | Returns a copy of all payment records |
| `getPaymentCount()` | `number` | Returns the number of recorded payments |
| `clearHistory()` | `void` | Deletes all payment records |
| `pruneExpiredRecords(maxAgeSeconds?)` | `void` | Removes records older than `maxAgeSeconds` (default: 604800 = 7 days) |

**Example:**

```typescript
import { BudgetTracker } from "@sigloop/sdk";

const tracker = new BudgetTracker({
  maxPerRequest: 1000000n,
  maxDaily: 10000000n,
  allowedDomains: ["api.example.com"],
  allowedAssets: ["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"],
});

const allowed = tracker.canSpend(
  500000n,
  "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
  "api.example.com"
);
console.log("Can spend:", allowed);
console.log("Daily remaining:", tracker.getRemainingDailyBudget());

// After some payments:
tracker.pruneExpiredRecords(86400); // keep only last 24 hours
```

---

## HTTP Client

### `X402ClientOptions`

```typescript
interface X402ClientOptions {
  account: LocalAccount;
  walletAddress: Address;
  chainId: number;
  config: X402Config;
  baseUrl?: string;
  defaultHeaders?: Record<string, string>;
  onPayment?: (record: PaymentRecord) => void;
  onPaymentRejected?: (reason: string) => void;
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `account` | `LocalAccount` | Yes | The signing account |
| `walletAddress` | `Address` | Yes | The wallet address for payments |
| `chainId` | `number` | Yes | The chain ID |
| `config` | [`X402Config`](./types.md#x402config) | Yes | Payment budget configuration |
| `baseUrl` | `string` | No | Base URL prepended to relative paths |
| `defaultHeaders` | `Record<string, string>` | No | Headers included in every request |
| `onPayment` | `(record: PaymentRecord) => void` | No | Callback on successful payment |
| `onPaymentRejected` | `(reason: string) => void` | No | Callback on rejected payment |

### `X402Client`

```typescript
interface X402Client {
  fetch: typeof fetch;
  get: (url: string, headers?: Record<string, string>) => Promise<Response>;
  post: (url: string, body: unknown, headers?: Record<string, string>) => Promise<Response>;
  put: (url: string, body: unknown, headers?: Record<string, string>) => Promise<Response>;
  delete: (url: string, headers?: Record<string, string>) => Promise<Response>;
  getBudgetTracker: () => BudgetTracker;
}
```

---

### `createX402Client`

Creates a high-level HTTP client with built-in x402 payment support and convenience methods for common HTTP verbs. Relative URLs are resolved against `baseUrl` if provided.

```typescript
function createX402Client(options: X402ClientOptions): X402Client
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `options` | `X402ClientOptions` | Client configuration |

**Returns:** [`X402Client`](./types.md) -- An HTTP client with automatic payment handling.

**Example:**

```typescript
import { createX402Client } from "@sigloop/sdk";
import { privateKeyToAccount } from "viem/accounts";

const account = privateKeyToAccount("0x...");

const client = createX402Client({
  account,
  walletAddress: "0xMyWallet...",
  chainId: 8453,
  config: {
    maxPaymentPerRequest: 1000000n,
    maxTotalPayment: 50000000n,
    autoApprove: true,
  },
  baseUrl: "https://api.example.com",
  defaultHeaders: {
    "X-API-Key": "my-key",
  },
  onPayment: (record) => console.log("Paid:", record.amount),
});

// GET request
const getResp = await client.get("/premium/data");

// POST request with JSON body
const postResp = await client.post("/premium/action", { action: "execute" });

// PUT request
const putResp = await client.put("/premium/resource/123", { value: "updated" });

// DELETE request
const delResp = await client.delete("/premium/resource/123");

// Access the underlying fetch
const customResp = await client.fetch("https://other-api.com/endpoint", {
  method: "PATCH",
  body: JSON.stringify({ patch: true }),
});

// Check budget
const tracker = client.getBudgetTracker();
console.log("Total spent:", tracker.getTotalSpend());
console.log("Daily remaining:", tracker.getRemainingDailyBudget());
```

---

[<- Back to README](./README.md) | [Previous: Policy](./policy.md) | [Next: Chain ->](./chain.md)
